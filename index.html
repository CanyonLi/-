<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🐱🍣 小猫寿司扫雷 🍣🐱</title>
  <style>
    /* 整体背景与排版 */
    body {
      margin: 0;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #f6d365, #fda085);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #2c3e50;
    }
    header {
      text-align: center;
      padding: 10px 20px;
    }
    header h1 {
      margin: 0;
      font-size: 2rem;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    header p {
      margin: 5px 0 0;
      font-size: 1rem;
    }
    /* 控制区：包含难度选择、开始、排行榜、自定义等 */
    #game-controls {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      padding: 10px 15px;
      margin: 10px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    #game-controls select,
    #game-controls button {
      padding: 6px 10px;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #game-controls select {
      background: #ecf0f1;
      color: #2c3e50;
    }
    #game-controls button {
      background: #81c784;
      color: #fff;
    }
    #game-controls button:hover {
      background: #66bb6a;
    }
    #game-controls div {
      font-size: 1rem;
      margin-top: 5px;
    }
    /* 游戏区域 */
    #board {
      display: grid;
      margin: 10px 0;
      /* 棋盘宽高将在 JS 中根据列数/行数设置 */
      border: 4px solid #2c3e50;
      background: #ecf0f1;
    }
    .cell {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #bdc3c7;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
      user-select: none;
      font-weight: bold;
    }
    .cell:hover {
      transform: scale(1.1);
      background-color: #dcedc1;
    }
    .cell.revealed {
      background-color: #f7f7f7;
      cursor: default;
    }
    .cell.flag {
      background-color: #ffe0b2;
    }
    .cell.mine {
      background-color: #e57373;
    }
    .cell.number {
      background-color: #f7f7f7;
    }
    /* 数字颜色：仿经典扫雷 */
    .num-1 { color: blue; }
    .num-2 { color: green; }
    .num-3 { color: red; }
    .num-4 { color: darkblue; }
    .num-5 { color: maroon; }
    .num-6 { color: teal; }
    .num-7 { color: black; }
    .num-8 { color: gray; }
    /* 帮助提示 */
    #help {
      background: rgba(255, 255, 255, 0.8);
      padding: 8px 12px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      font-size: 0.9rem;
      text-align: center;
      margin-bottom: 10px;
    }
    /* 移动端优化 */
    @media (max-width: 600px) {
      .cell { width: 18px; height: 18px; font-size: 0.8rem; }
      header h1 { font-size: 1.5rem; }
      #game-controls select, 
      #game-controls button { font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>🐱🍣 小猫寿司扫雷 🍣🐱</h1>
    <p>体验猫咪与寿司的奇妙组合！</p>
  </header>
  <div id="game-controls">
    <select id="difficulty">
      <option value="0">初级 (9x9, 10 寿司)</option>
      <option value="1">中级 (16x16, 40 寿司)</option>
      <option value="2">高级 (16x30, 99 寿司)</option>
    </select>
    <button id="start-button">开始/重置游戏</button>
    <button id="custom-button">自定义模式</button>
    <button id="record-button">排行榜</button>
    <div>
      <span>剩余寿司数: <span id="mine-counter">0</span></span>
      &nbsp;&nbsp;&nbsp;
      <span>计时: <span id="timer">0:0</span></span>
    </div>
  </div>
  <div id="board"></div>
  <div id="help">
    <p>提示：左键点击翻开格子；右键或长按插旗（移动端支持）；空格键或点击“开始/重置游戏”重置。</p>
  </div>
  <!-- 可选音效（需提供对应音频文件） -->
  <audio id="sound-click" src="click.mp3" preload="auto"></audio>
  <audio id="sound-explosion" src="explosion.mp3" preload="auto"></audio>
  <script>
    // 全局变量与常量
    let boardElement = document.getElementById('board');
    let difficultySelect = document.getElementById('difficulty');
    let startButton = document.getElementById('start-button');
    let customButton = document.getElementById('custom-button');
    let recordButton = document.getElementById('record-button');
    let mineCounterElement = document.getElementById('mine-counter');
    let timerElement = document.getElementById('timer');
    let timerInterval = null;
    let timeCount = 0;
    
    let rows, cols, mineCount;
    let board = [];    // 二维数组存储每个格子的 DOM 元素
    let mineMap = [];  // 二维数组存储雷区数据，'*'表示雷，其它数字表示周围雷数
    let revealedCount = 0;
    let gameOver = false;
    const directions = [
      [-1,-1], [-1,0], [-1,1],
      [0,-1],          [0,1],
      [1,-1],  [1,0],  [1,1]
    ];
    
    // 根据难度设置行数、列数及寿司数（即雷数）
    function setDifficulty(level) {
      switch (parseInt(level)) {
        case 0:
          rows = 9; cols = 9; mineCount = 10;
          break;
        case 1:
          rows = 16; cols = 16; mineCount = 40;
          break;
        case 2:
          rows = 16; cols = 30; mineCount = 99;
          break;
        default:
          rows = 9; cols = 9; mineCount = 10;
      }
      mineCounterElement.textContent = mineCount;
    }
    
    // 启动计时器
    function startTimer() {
      clearInterval(timerInterval);
      timeCount = 0;
      timerElement.textContent = "0:0";
      timerInterval = setInterval(() => {
        timeCount++;
        let minutes = Math.floor(timeCount / 60);
        let seconds = timeCount % 60;
        timerElement.textContent = minutes + ":" + seconds;
      }, 1000);
    }
    
    // 停止计时器
    function stopTimer() {
      clearInterval(timerInterval);
    }
    
    // 重置游戏：初始化棋盘、数据、计时器
    function resetGame() {
      stopTimer();
      boardElement.innerHTML = "";
      board = [];
      mineMap = [];
      revealedCount = 0;
      gameOver = false;
      setDifficulty(difficultySelect.value);
      // 根据列数设置棋盘宽高（每个格子22px含边框间隙）
      boardElement.style.width = (cols * 22) + "px";
      boardElement.style.height = (rows * 22) + "px";
      boardElement.style.gridTemplateColumns = `repeat(${cols}, 20px)`;
      boardElement.style.gridTemplateRows = `repeat(${rows}, 20px)`;
      
      // 创建棋盘
      for (let r = 0; r < rows; r++) {
        board[r] = [];
        mineMap[r] = [];
        for (let c = 0; c < cols; c++) {
          let cell = document.createElement('div');
          cell.classList.add('cell');
          cell.dataset.row = r;
          cell.dataset.col = c;
          cell.addEventListener('click', cellClick);
          cell.addEventListener('contextmenu', cellRightClick);
          // 移动端：长按标记
          let touchTimer = null;
          cell.addEventListener('touchstart', (e) => {
            if (gameOver) return;
            touchTimer = setTimeout(() => {
              cellRightClick(e);
            }, 600);
          });
          cell.addEventListener('touchend', (e) => {
            clearTimeout(touchTimer);
          });
          boardElement.appendChild(cell);
          board[r][c] = cell;
          mineMap[r][c] = 0;
        }
      }
    }
    
    // 生成雷区（保证首次点击安全）
    function generateMines(firstRow, firstCol) {
      let placed = 0;
      while (placed < mineCount) {
        let r = Math.floor(Math.random() * rows);
        let c = Math.floor(Math.random() * cols);
        if ((r === firstRow && c === firstCol) || mineMap[r][c] === '*') continue;
        mineMap[r][c] = '*';
        placed++;
      }
      // 根据雷区生成数字提示
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          if (mineMap[r][c] === '*') continue;
          let count = 0;
          for (let [dr, dc] of directions) {
            let nr = r + dr, nc = c + dc;
            if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && mineMap[nr][nc] === '*') {
              count++;
            }
          }
          mineMap[r][c] = count;
        }
      }
    }
    
    // 返回与主题相关的雷 emoji（仅使用猫和寿司）
    function getMineEmoji() {
      return Math.random() > 0.5 ? "🐱" : "🍣";
    }
    
    // 根据数字返回对应颜色的 class 名（仿扫雷经典）
    function getNumberClass(num) {
      switch (num) {
        case 1: return "num-1";
        case 2: return "num-2";
        case 3: return "num-3";
        case 4: return "num-4";
        case 5: return "num-5";
        case 6: return "num-6";
        case 7: return "num-7";
        case 8: return "num-8";
        default: return "";
      }
    }
    
    // 左键点击：翻开格子
    function cellClick(e) {
      if (gameOver) return;
      let cell = e.currentTarget;
      let r = parseInt(cell.dataset.row);
      let c = parseInt(cell.dataset.col);
      if (revealedCount === 0) {
        generateMines(r, c);
        startTimer();
      }
      if (cell.classList.contains('flag')) return;
      revealCell(r, c);
      checkWin();
    }
    
    // 右键点击或长按：标记/取消标记
    function cellRightClick(e) {
      e.preventDefault();
      if (gameOver) return;
      let cell = e.currentTarget;
      if (cell.classList.contains('revealed')) return;
      if (cell.classList.contains('flag')) {
        cell.classList.remove('flag');
        cell.textContent = "";
        mineCounterElement.textContent = parseInt(mineCounterElement.textContent) + 1;
      } else {
        cell.classList.add('flag');
        cell.textContent = "🐾"; // 使用可爱的爪印作为旗帜
        mineCounterElement.textContent = parseInt(mineCounterElement.textContent) - 1;
      }
    }
    
    // 翻开格子（递归展开空白区域）
    function revealCell(r, c) {
      if (r < 0 || r >= rows || c < 0 || c >= cols) return;
      let cell = board[r][c];
      if (cell.classList.contains('revealed') || cell.classList.contains('flag')) return;
      cell.classList.add('revealed');
      revealedCount++;
      // 可选：播放点击音效
      // document.getElementById('sound-click').play();
      if (mineMap[r][c] === '*') {
        cell.classList.add('mine');
        cell.textContent = getMineEmoji();
        gameOverFn(false);
      } else if (mineMap[r][c] > 0) {
        cell.classList.add('number');
        cell.textContent = mineMap[r][c];
        cell.classList.add(getNumberClass(mineMap[r][c]));
      } else {
        // 空白区域，递归展开相邻格子
        for (let [dr, dc] of directions) {
          revealCell(r + dr, c + dc);
        }
      }
    }
    
    // 游戏结束：显示所有雷、禁用交互、弹窗提示
    function gameOverFn(win) {
      gameOver = true;
      stopTimer();
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          let cell = board[r][c];
          if (mineMap[r][c] === '*' && !cell.classList.contains('revealed')) {
            cell.classList.add('mine');
            cell.textContent = getMineEmoji();
          }
          cell.removeEventListener('click', cellClick);
          cell.removeEventListener('contextmenu', cellRightClick);
        }
      }
      // 可选：播放爆炸音效
      // document.getElementById('sound-explosion').play();
      setTimeout(() => {
        alert(win ? "恭喜你！你赢了！" : "游戏失败！");
      }, 200);
    }
    
    // 检查胜利条件
    function checkWin() {
      if (revealedCount === rows * cols - mineCount) {
        gameOverFn(true);
      }
    }
    
    // 自定义模式：弹出输入提示，允许玩家设置行数、列数和雷数
    customButton.addEventListener('click', () => {
      let customRows = parseInt(prompt("请输入行数 (建议范围: 5-30):", "16"));
      let customCols = parseInt(prompt("请输入列数 (建议范围: 5-50):", "30"));
      let customMines = parseInt(prompt("请输入寿司数 (建议范围: 5 至 行数×列数-1):", "99"));
      if (customRows && customCols && customMines && customMines < customRows * customCols) {
        rows = customRows;
        cols = customCols;
        mineCount = customMines;
        mineCounterElement.textContent = mineCount;
        resetGame();
      } else {
        alert("输入不合法，请重试！");
      }
    });
    
    // 排行榜按钮（目前为占位功能）
    recordButton.addEventListener('click', () => {
      alert("排行榜功能待开发！");
    });
    
    // 开始/重置按钮与空格键绑定重置游戏
    startButton.addEventListener('click', resetGame);
    window.addEventListener('keydown', (e) => {
      if (e.key === ' ' && !gameOver) {
        e.preventDefault();
        resetGame();
      }
    });
    
    // 页面加载完成后初始化游戏
    window.addEventListener('load', resetGame);
  </script>
</body>
</html>
